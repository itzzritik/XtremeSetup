---
- name: Setup Local Environment
  hosts: local
  connection: local
  gather_facts: true
  tasks:
      - name: Install Ansible Requirements
        command: ansible-galaxy collection install -r requirements.yml --upgrade
        register: galaxy_install
        changed_when: "'Installing' in galaxy_install.stdout"

      - name: Environment Setup
        include_tasks: tasks/env.yml

- name: Deploy to Remote Proxmox
  hosts: proxmox
  gather_facts: true
  pre_tasks:
      - name: Restore Environment Variables
        set_fact:
            env: '{{ hostvars["local"]["env"] }}'
        no_log: true

  tasks:
      - name: Find System Tasks
        ansible.builtin.find:
            paths: '{{ playbook_dir }}/tasks/system'
            patterns: '*.yml'
        register: system_tasks
        delegate_to: localhost
        run_once: true

      - name: Find Instance Tasks
        ansible.builtin.find:
            paths: '{{ playbook_dir }}/tasks/instances'
            patterns: 'index.yml'
            recurse: true
            depth: 2
        register: instance_tasks
        delegate_to: localhost
        run_once: true

      - name: Include Found Tasks
        include_tasks: '{{ task_file.path }}'
        loop: '{{ system_tasks.files + instance_tasks.files }}'
        loop_control:
            loop_var: task_file
            label: '{{ task_file.path | relpath(playbook_dir) }}'
