---
- name: Setup Local Environment
  hosts: local
  connection: local
  gather_facts: true
  tasks:
      - name: Install Ansible Requirements
        command: ansible-galaxy collection install -r requirements.yml --upgrade
        register: galaxy_install
        changed_when: "'Installing' in galaxy_install.stdout"

      - name: Environment Setup
        include_tasks: tasks/env.yml

- name: Deploy to Remote Proxmox
  hosts: proxmox
  gather_facts: true
  pre_tasks:
      - name: Restore Environment Variables
        set_fact:
            env: '{{ hostvars["local"]["env"] }}'
        no_log: true

  tasks:
      - name: System Update
        include_tasks: tasks/system/update.yml

      - name: Automount Drives
        include_tasks: tasks/system/automount.yml

      - name: Run Home Assistant OS Installer
        include_tasks: tasks/instances/home_vm.yml

      - name: Run Jellyfin Installer
        include_tasks: tasks/instances/jellyfin_lxc.yml

      # - name: Run Apps Installer
      #   include_tasks: tasks/instances/apps_lxc.yml

      - name: Run Traefik Installer
        include_tasks: tasks/instances/traefik_lxc.yml

      - name: Run Pihole Installer
        include_tasks: tasks/instances/pihole_lxc.yml

      - name: Run Qbittorrent Installer
        include_tasks: tasks/instances/qbittorrent_lxc.yml
