---
- name: Task Banner
  debug:
      msg: |

          +-----------------------------------------------------------------------------------------------------------------------------------+

          â— Setting up Environment (Doppler + Local)

- vars:
      doppler_info:
          project: jarvis
          config: prd
  block:
      - name: Install Doppler (MacOS)
        homebrew:
            name: dopplerhq/cli/doppler
            state: present

      - name: Ensure Doppler Project Configured (Retry Loop)
        shell: |
            if doppler setup --project {{ doppler_info.project }} --config {{ doppler_info.config }} > /dev/null 2>&1; then
                exit 0
            fi

            USER_INFO=$(doppler me 2>&1)
            echo "----------------------------------------------------------------"
            echo "ERROR: Project '{{ doppler_info.project }}' not found with config '{{ doppler_info.config }}'."
            echo "Current User Info:"
            echo "$USER_INFO"
            echo "----------------------------------------------------------------"
            echo "Please login with the account that has access to '{{ doppler_info.project }}' project"

            yes | doppler login > /dev/null
            exit 1
        register: doppler_setup_result
        until: doppler_setup_result.rc == 0
        retries: 10
        delay: 1
        changed_when: false

      - name: Download Secrets
        command: doppler secrets download --no-file --format json
        register: secrets_output
        changed_when: false

      - name: Parse Secrets
        set_fact:
            doppler_secrets: '{{ secrets_output.stdout | from_json }}'

      - name: Define Required Secrets
        set_fact:
            required_secrets:
                - JARVIS_ADMIN_EMAIL
                - JARVIS_ADMIN_NAME
                - JARVIS_ADMIN_PASSWORD
                - JARVIS_AUTH_GITHUB_CLIENT_ID
                - JARVIS_AUTH_GITHUB_CLIENT_SECRET
                - JARVIS_AUTH_GOOGLE_APP_PASSWORD
                - JARVIS_AUTH_GOOGLE_CLIENT_ID
                - JARVIS_AUTH_GOOGLE_CLIENT_SECRET
                - JARVIS_AUTH_SESSION_KEY
                - JARVIS_AUTH_X_CLIENT_ID
                - JARVIS_AUTH_X_CLIENT_SECRET
                - JARVIS_CF_DNS_API_TOKEN
                - JARVIS_CF_TUNNEL_TOKEN
                - JARVIS_DOMAIN
                - JARVIS_GITHUB_TOKEN_SSH
                - JARVIS_POSTGRES_PASSWORD
                - JARVIS_HOST_IP

      - name: Validate Secrets
        fail:
            msg: 'Missing secret: {{ item }}. Please check your Doppler project.'
        loop: '{{ required_secrets }}'
        when: item not in doppler_secrets

      - name: Construct Global Environment
        set_fact:
            env: '{{ doppler_secrets | combine(local_config) }}'
        vars:
            local_config:
                configs_dir: '/root/.jarvis/configs'

      - name: Success Message
        debug:
            msg: 'Environment configured successfully. {{ env.keys() | length }} variables loaded.'
