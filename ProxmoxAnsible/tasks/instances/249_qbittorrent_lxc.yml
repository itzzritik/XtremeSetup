- vars:
      id: 249
      instance:
          hostname: qbittorrent
          memory: 2048
          swap: 512
          cores: 2
          storage: local-lvm
          ip: '{{ env.JARVIS_NETWORK_PREFIX }}.{{ id }}'
          gateway: '{{ env.JARVIS_GATEWAY }}'
          subuid: '100000'
      paths:
          config: '{{ env.JARVIS_CONFIGS_DIR }}/{{ instance.hostname }}/config'
          data: '{{ env.JARVIS_CONFIGS_DIR }}/{{ instance.hostname }}/data'
  block:
      - name: '{{ instance.hostname | upper }}: Check if Instance exists'
        uri:
            url: 'http://{{ instance.ip }}/'
            timeout: 5
        register: instance_check
        failed_when: false
        changed_when: false

      - set_fact:
            instance_exists: '{{ instance_check.status | default(0) == 200 }}'

      - name: '{{ instance.hostname | upper }}: Create Config Directories on Host'
        file:
            path: '{{ item }}'
            state: directory
            mode: '0755'
            owner: '{{ instance.subuid }}'
            group: '{{ instance.subuid }}'
            recurse: true
        loop:
            - '{{ paths.config }}'
            - '{{ paths.data }}'

      - name: '{{ instance.hostname | upper }}: Provision Instance'
        block:
            - name: '{{ instance.hostname | upper }}: Stop and Destroy LXC'
              shell: pct stop {{ id }}; pct destroy {{ id }}
              failed_when: false
              changed_when: false

            - name: '{{ instance.hostname | upper }}: Create Temporary Install Directory'
              tempfile:
                  state: directory
                  suffix: _qbittorrent_install
              register: temp_install_dir

            - name: '{{ instance.hostname | upper }}: Create default.vars for Silent Install'
              copy:
                  dest: '{{ temp_install_dir.path }}/default.vars'
                  content: |
                      var_container_storage={{ instance.storage }}
                      var_template_storage={{ instance.storage }}

            - name: '{{ instance.hostname | upper }}: Install qBittorrent using community script'
              shell: |
                  export var_os="ubuntu"
                  export var_version="24.04"
                  export DEBIAN_FRONTEND=noninteractive
                  export mode="default"
                  export var_ctid="{{ id }}"
                  export var_hostname="{{ instance.hostname }}"
                  export var_cpu="{{ instance.cores }}"
                  export var_ram="{{ instance.memory }}"
                  export var_swap="{{ instance.swap }}"
                  export var_disk="8"
                  export var_net="{{ instance.ip }}/24"
                  export var_gateway="{{ instance.gateway }}"
                  export var_unprivileged="1"
                  export TERM=xterm
                  echo -e "y" | bash -c "$(curl -fsSL {{ env.JARVIS_COMMUNITY_SCRIPTS_URL }}/ct/qbittorrent.sh)"
              args:
                  chdir: '{{ temp_install_dir.path }}'
                  executable: /bin/bash
              register: qbittorrent_install

            - name: '{{ instance.hostname | upper }}: Show qBittorrent Install Output'
              debug:
                  var: qbittorrent_install.stdout_lines

            - name: '{{ instance.hostname | upper }}: Cleanup Temporary Directory'
              file:
                  path: '{{ temp_install_dir.path }}'
                  state: absent

            - name: '{{ instance.hostname | upper }}: Stop LXC for Configuration'
              command: pct stop {{ id }}
              ignore_errors: true

            - name: '{{ instance.hostname | upper }}: Configure LXC Mounts'
              blockinfile:
                  path: '/etc/pve/lxc/{{ id }}.conf'
                  marker: '# {mark} ANSIBLE MANAGED BLOCK'
                  block: |
                      mp0: /mnt/wdhdd,mp=/media/wdhdd
                      mp1: /mnt/ssd,mp=/media/ssd
                      mp2: {{ paths.config }},mp=/root/.config/qBittorrent
                      mp3: {{ paths.data }},mp=/root/.local/share/qBittorrent

            - name: '{{ instance.hostname | upper }}: Start LXC'
              command: pct start {{ id }}

            - name: '{{ instance.hostname | upper }}: Wait for qBittorrent to be ready (Internal Port)'
              wait_for:
                  host: '{{ instance.ip }}'
                  port: 8080
                  delay: 5
                  timeout: 120

            - name: '{{ instance.hostname | upper }}: Install Dependencies'
              shell: pct exec {{ id }} -- apt-get update && pct exec {{ id }} -- apt-get install -y unzip iptables python3

            - name: '{{ instance.hostname | upper }}: Install VueTorrent'
              shell: |
                  pct exec {{ id }} -- bash -c "rm -rf /opt/vuetorrent /opt/VueTorrent && \
                  wget -qO /tmp/vuetorrent.zip https://github.com/VueTorrent/VueTorrent/releases/latest/download/vuetorrent.zip && \
                  unzip -o /tmp/vuetorrent.zip -d /opt && \
                  if [ -d '/opt/VueTorrent' ]; then mv /opt/VueTorrent /opt/vuetorrent; fi && \
                  rm /tmp/vuetorrent.zip"
              args:
                  executable: /bin/bash

            - name: '{{ instance.hostname | upper }}: Generate qBittorrent Password Hash'
              shell: |
                  python3 -c 'import base64, hashlib, os; password = os.environ.get("QB_PASSWORD", "").encode(); salt = os.urandom(16); key = hashlib.pbkdf2_hmac("sha512", password, salt, 100000); print("@ByteArray({}:{})".format(base64.b64encode(salt).decode(), base64.b64encode(key).decode()), end="")'
              environment:
                  QB_PASSWORD: '{{ env.JARVIS_ADMIN_PASSWORD }}'
              register: qbit_password_hash
              changed_when: false

            - name: '{{ instance.hostname | upper }}: Stop qBittorrent for Config'
              command: pct exec {{ id }} -- systemctl stop qbittorrent-nox
              ignore_errors: true

            - name: '{{ instance.hostname | upper }}: Ensure qBittorrent Config Exists'
              copy:
                  content: "[Preferences]\n"
                  dest: '{{ paths.config }}/qBittorrent.conf'
                  force: false
                  owner: '{{ instance.subuid }}'
                  group: '{{ instance.subuid }}'
                  mode: '0644'

            - name: '{{ instance.hostname | upper }}: Configure qBittorrent Settings'
              community.general.ini_file:
                  path: '{{ paths.config }}/qBittorrent.conf'
                  section: 'Preferences'
                  option: '{{ item.key }}'
                  value: '{{ item.value }}'
                  owner: '{{ instance.subuid }}'
                  group: '{{ instance.subuid }}'
                  mode: '0644'
              loop:
                  - { key: 'WebUI\HostHeaderValidation', value: 'false' }
                  - { key: 'WebUI\AlternativeUIEnabled', value: 'true' }
                  - { key: 'WebUI\RootFolder', value: '/opt/vuetorrent' }
                  - { key: 'Downloads\SavePath', value: '/media/wdhdd/torrents' }
                  - { key: 'WebUI\Username', value: '{{ env.JARVIS_ADMIN_USERNAME }}' }
                  - { key: 'WebUI\Password_PBKDF2', value: '{{ qbit_password_hash.stdout }}' }

            - name: '{{ instance.hostname | upper }}: Start qBittorrent'
              command: pct exec {{ id }} -- systemctl start qbittorrent-nox

            - name: '{{ instance.hostname | upper }}: Configure Port Forwarding (80 -> 8080)'
              shell: |
                  pct exec {{ id }} -- bash -c "cat <<EOF > /etc/systemd/system/qbittorrent-port-forward.service
                  [Unit]
                  Description=Qbittorrent Port Forward 80 to 8080
                  After=network.target

                  [Service]
                  Type=oneshot
                  ExecStart=/usr/sbin/iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080
                  ExecStop=/usr/sbin/iptables -t nat -D PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080
                  RemainAfterExit=yes

                  [Install]
                  WantedBy=multi-user.target
                  EOF
                  systemctl daemon-reload && \
                  systemctl enable --now qbittorrent-port-forward.service"
              args:
                  executable: /bin/bash

            - name: '{{ instance.hostname | upper }}: Wait for qBittorrent on Port 80'
              wait_for:
                  host: '{{ instance.ip }}'
                  port: 80
                  delay: 2
                  timeout: 30

        when: not instance_exists

  rescue:
      - debug:
            msg: '{{ instance.hostname }} ({{ id }}) failed to deploy'
  become: true
