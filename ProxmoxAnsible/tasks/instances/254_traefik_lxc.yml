- vars:
      id: 254
      instance:
          hostname: traefik
          memory: 2048
          swap: 512
          cores: 2
          storage: local-lvm
          ip: '{{ env.JARVIS_NETWORK_PREFIX }}.{{ id }}'
          gateway: '{{ env.JARVIS_GATEWAY }}'
          subuid: '100000'
      paths:
          config: '{{ env.JARVIS_CONFIGS_DIR }}/{{ instance.hostname }}/traefik'
          cloudflared_config: '{{ env.JARVIS_CONFIGS_DIR }}/{{ instance.hostname }}/cloudflared'
      service_mappings:
          homer:
              root_domain: true
              url: http://192.168.68.251:80
          traefik:
              subdomains: [proxy]
              url: api@internal
              is_internal: true
          proxmox:
              subdomains: [pm]
              url: https://192.168.68.200:8006
              insecure: true
          home:
              subdomains: [home]
              url: http://192.168.68.250:8123
          jellyfin:
              subdomains: [media]
              url: http://192.168.68.248:8096
          pihole:
              subdomains: [dns]
              url: http://192.168.68.252:80
              middlewares: [pihole-redirect]
          qbittorrent:
              subdomains: [torrent]
              url: http://192.168.68.249:80
  block:
      - name: '{{ instance.hostname | upper }}: Check if Instance exists'
        uri:
            url: 'http://{{ instance.ip }}:8080'
            timeout: 5
        register: instance_check
        failed_when: false
        changed_when: false

      - set_fact:
            instance_exists: '{{ instance_check.status | default(0) == 200 }}'

      - name: '{{ instance.hostname | upper }}: Create Config Directories on Host'
        file:
            path: '{{ item }}'
            state: directory
            mode: '0755'
            owner: '{{ instance.subuid }}'
            group: '{{ instance.subuid }}'
            recurse: true
        loop:
            - '{{ paths.config }}'
            - '{{ paths.config }}/dynamic'
            - '{{ paths.cloudflared_config }}'

      - name: '{{ instance.hostname | upper }}: Provision Instance'
        block:
            - name: '{{ instance.hostname | upper }}: Stop and Destroy LXC'
              shell: pct stop {{ id }}; pct destroy {{ id }}
              failed_when: false
              changed_when: false

            - name: '{{ instance.hostname | upper }}: Create Temporary Install Directory'
              tempfile:
                  state: directory
                  suffix: _traefik_install
              register: temp_install_dir

            - name: '{{ instance.hostname | upper }}: Create default.vars for Silent Install'
              copy:
                  dest: '{{ temp_install_dir.path }}/default.vars'
                  content: |
                      var_container_storage={{ instance.storage }}
                      var_template_storage={{ instance.storage }}
                      var_sysctl_conf="net.ipv4.ip_forward=1"

            - name: '{{ instance.hostname | upper }}: Install Traefik using community script'
              shell: |
                  export mode="default"
                  export var_ctid="{{ id }}"
                  export var_hostname="{{ instance.hostname }}"
                  export var_cpu="{{ instance.cores }}"
                  export var_ram="{{ instance.memory }}"
                  export var_disk="8"
                  export var_net="{{ instance.ip }}/24"
                  export var_gateway="{{ instance.gateway }}"
                  export var_unprivileged="1"
                  export TERM=xterm
                  bash -c "$(curl -fsSL {{ env.JARVIS_COMMUNITY_SCRIPTS_URL }}/ct/traefik.sh)"
              args:
                  chdir: '{{ temp_install_dir.path }}'
                  executable: /bin/bash
              register: traefik_install

            - name: '{{ instance.hostname | upper }}: Show Traefik Install Output'
              debug:
                  var: traefik_install.stdout_lines

            - name: '{{ instance.hostname | upper }}: Cleanup Temporary Directory'
              file:
                  path: '{{ temp_install_dir.path }}'
                  state: absent

            - name: '{{ instance.hostname | upper }}: Stop LXC for Configuration'
              command: pct stop {{ id }}
              ignore_errors: true

            - name: '{{ instance.hostname | upper }}: Set Swap Size'
              command: pct set {{ id }} -swap {{ instance.swap }}

            - name: '{{ instance.hostname | upper }}: Configure LXC Mounts'
              blockinfile:
                  path: '/etc/pve/lxc/{{ id }}.conf'
                  marker: '# {mark} ANSIBLE MANAGED BLOCK'
                  block: |
                      mp0: {{ paths.config }},mp=/etc/traefik
                      mp1: {{ paths.cloudflared_config }},mp=/etc/cloudflared

            - name: '{{ instance.hostname | upper }}: Start LXC'
              command: pct start {{ id }}

        when: not instance_exists

      - name: '{{ instance.hostname | upper }}: Configure Traefik'
        block:
            - name: '{{ instance.hostname | upper }}: Ensure acme.json exists'
              file:
                  path: '{{ paths.config }}/acme.json'
                  state: touch
                  access_time: preserve
                  modification_time: preserve
                  mode: '0600'
                  owner: '{{ instance.subuid }}'
                  group: '{{ instance.subuid }}'

            - name: '{{ instance.hostname | upper }}: Update Traefik Static Config (traefik.yml)'
              copy:
                  dest: '{{ paths.config }}/traefik.yml'
                  content: |
                      global:
                        checkNewVersion: true
                        sendAnonymousUsage: false

                      log:
                        level: INFO

                      api:
                        dashboard: true
                        insecure: true

                      entryPoints:
                        web:
                          address: ":80"
                          http:
                            redirections:
                              entryPoint:
                                to: websecure
                                scheme: https
                        websecure:
                          address: ":443"
                          http:
                            tls:
                              certResolver: letsencrypt

                      providers:
                        file:
                          directory: /etc/traefik/dynamic
                          watch: true

                      certificatesResolvers:
                        letsencrypt:
                          acme:
                            email: "{{ env.JARVIS_ADMIN_EMAIL }}"
                            storage: /etc/traefik/acme.json
                            dnsChallenge:
                              provider: cloudflare
                              resolvers:
                                - "1.1.1.1:53"
                                - "8.8.8.8:53"
                  owner: '{{ instance.subuid }}'
                  group: '{{ instance.subuid }}'
                  mode: '0644'

            - name: '{{ instance.hostname | upper }}: Update Traefik Dynamic Rules (rules.yml)'
              copy:
                  dest: '{{ paths.config }}/dynamic/rules.yml'
                  content: |
                      http:
                        serversTransports:
                          insecureTransport:
                            insecureSkipVerify: true

                        middlewares:
                          pihole-redirect:
                            redirectRegex:
                              regex: "^https?://pihole\\.{{ env.JARVIS_DOMAIN | replace('.', '\\.') }}/?$"
                              replacement: "https://pihole.{{ env.JARVIS_DOMAIN }}/admin/"

                        routers:
                      {% for service_item in service_mappings | dict2items %}
                          {{ service_item.key }}:
                            rule: "{% if service_item.value.root_domain | default(false) %}Host(`{{ env.JARVIS_DOMAIN }}`){% else %}{% for subdomain in service_item.value.subdomains %}Host(`{{ subdomain }}.{{ env.JARVIS_DOMAIN }}`){% if not loop.last %} || {% endif %}{% endfor %}{% endif %}"
                            service: "{{ 'api@internal' if service_item.value.is_internal | default(false) else service_item.key }}"
                      {% if service_item.value.middlewares | default([]) | length > 0 %}
                            middlewares:
                      {% for middleware in service_item.value.middlewares %}
                              - "{{ middleware }}"
                      {% endfor %}
                      {% endif %}
                      {% endfor %}

                        services:
                      {% for service_item in service_mappings | dict2items %}
                      {% if not service_item.value.is_internal | default(false) %}
                          {{ service_item.key }}:
                            loadBalancer:
                              servers:
                                - url: "{{ service_item.value.url }}"
                      {% if service_item.value.insecure | default(false) %}
                              serversTransport: "insecureTransport"
                      {% endif %}
                      {% endif %}
                      {% endfor %}
                  owner: '{{ instance.subuid }}'
                  group: '{{ instance.subuid }}'
                  mode: '0644'

            - name: '{{ instance.hostname | upper }}: Configure Service Override'
              shell: |
                  pct exec {{ id }} -- bash -c "mkdir -p /etc/systemd/system/traefik.service.d && \
                  echo '[Service]' > /etc/systemd/system/traefik.service.d/override.conf && \
                  echo 'Environment=\"CF_DNS_API_TOKEN={{ env.JARVIS_CF_DNS_API_TOKEN }}\"' >> /etc/systemd/system/traefik.service.d/override.conf"

            - name: '{{ instance.hostname | upper }}: Restart Traefik Service'
              shell: pct exec {{ id }} -- bash -c "systemctl daemon-reload && systemctl restart traefik"

      - name: '{{ instance.hostname | upper }}: Configure Cloudflared'
        block:
            - name: '{{ instance.hostname | upper }}: Check if Cloudflared is installed'
              shell: pct exec {{ id }} -- bash -c "cloudflared --version"
              register: cloudflared_check
              failed_when: false
              changed_when: false

            - name: '{{ instance.hostname | upper }}: Install Cloudflared'
              shell: pct exec {{ id }} -- bash -c "wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb && dpkg -i cloudflared-linux-amd64.deb && rm cloudflared-linux-amd64.deb"
              when: cloudflared_check.rc != 0

            - name: '{{ instance.hostname | upper }}: Configure Cloudflared Service'
              shell: |
                  pct exec {{ id }} -- bash -c "cloudflared service uninstall || true"
                  pct exec {{ id }} -- bash -c "cloudflared service install {{ env.JARVIS_CF_TUNNEL_TOKEN }}"
              when: env.JARVIS_CF_TUNNEL_TOKEN is defined and env.JARVIS_CF_TUNNEL_TOKEN | length > 0

  rescue:
      - debug:
            msg: '{{ instance.hostname }} ({{ id }}) failed to deploy'
  become: true
