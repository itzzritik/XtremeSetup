- block:
      - name: 'BACKREST: Set Variables'
        set_fact:
            mapped_uid: '{{ instance.subuid | int + 1000 }}'
            app_name: backrest

      - name: 'BACKREST: Set Paths'
        set_fact:
            backrest:
                data: '{{ env.JARVIS_CONFIGS_DIR }}/{{ app_name }}/data'
                config: '{{ env.JARVIS_CONFIGS_DIR }}/{{ app_name }}/config'

      - name: 'BACKREST: Configure Directories'
        file:
            path: '{{ item }}'
            state: directory
            mode: '0755'
            owner: '{{ mapped_uid }}'
            group: '{{ mapped_uid }}'
            recurse: true
        loop:
            - '{{ backrest.data }}'
            - '{{ backrest.config }}'

      - name: 'BACKREST: Generate Bcrypt Hash'
        command: >
            {{ ansible_playbook_python }} -c 'import bcrypt; import base64; import os; password = os.environ["PASS"].encode("utf-8"); salt = bcrypt.gensalt(rounds=10); hashed = bcrypt.hashpw(password, salt); print(base64.b64encode(hashed).decode("utf-8"));'
        environment:
            PASS: '{{ env.JARVIS_ADMIN_PASSWORD }}'
        delegate_to: localhost
        register: admin_password_hash
        changed_when: false
        become: false

      - name: 'BACKREST: Create config.json'
        copy:
            dest: '{{ backrest.config }}/config.json'
            content: |
                {
                  "version": 6,
                  "instance": "backrest",
                  "auth": {
                    "users": [
                      {
                        "name": "{{ env.JARVIS_ADMIN_USERNAME }}",
                        "passwordBcrypt": "{{ admin_password_hash.stdout | trim }}"
                      }
                    ]
                  },
                  "repos": [
                    {
                      "id": "r2-backup",
                      "uri": "s3:{{ env.JARVIS_CF_R2_ENDPOINT }}/configs",
                      "password": "{{ env.JARVIS_ADMIN_PASSWORD }}",
                      "env": ["AWS_ACCESS_KEY_ID={{ env.JARVIS_CF_R2_TOKENS.split(':')[0] }}", "AWS_SECRET_ACCESS_KEY={{ env.JARVIS_CF_R2_TOKENS.split(':')[1] }}"],
                      "autoInitialize": true,
                      "prunePolicy": {
                        "maxUnusedPercent": 25
                      },
                      "flags": ["--verbose"]
                    }
                  ],
                  "plans": [
                    {
                      "id": "jarvis-configs",
                      "repo": "r2-backup",
                      "paths": ["/media/configs"],
                      "excludes": ["**/cache/**", "**/.cache/**", "**/logs/**"],
                      "schedule": {
                        "cron": "0 2 */2 * *",
                        "clock": "CLOCK_LOCAL"
                      },
                      "retention": {
                        "policyKeepLastN": 5,
                        "policyKeepDaily": 7,
                        "policyKeepWeekly": 4,
                        "policyKeepMonthly": 6
                      }
                    }
                  ]
                }
            owner: '{{ mapped_uid }}'
            group: '{{ mapped_uid }}'
            mode: '0644'

      - name: 'BACKREST: Create docker-compose.yml'
        copy:
            dest: '{{ backrest.config }}/../docker-compose.yml'
            content: |
                services:
                  {{ app_name }}:
                    container_name: {{ app_name }}
                    image: garethgeorge/backrest
                    restart: unless-stopped
                    ports:
                      - "{{ env.JARVIS_SERVICES[app_name].port }}:9898"
                    volumes:
                      - ./data:/app/data
                      - ./config:/app/config
                      - ../:/media/configs
                      - /media/ssd:/media/ssd
                      - /media/wdhdd:/media/wdhdd
            owner: '{{ mapped_uid }}'
            group: '{{ mapped_uid }}'
            mode: '0644'

      - name: 'BACKREST: Cleanup Existing Container'
        command: pct exec {{ id }} -- bash -c "docker stop {{ app_name }} 2>/dev/null || true; docker rm {{ app_name }} 2>/dev/null || true"
        changed_when: false

      - name: 'BACKREST: Start Docker Compose'
        command: pct exec {{ id }} -- bash -c "cd {{ instance.configs }}/{{ app_name }} && docker compose up -d"
        register: backrest_compose
        changed_when: "'Created' in backrest_compose.stderr or 'Recreated' in backrest_compose.stderr"

      - name: 'BACKREST: Wait for Service Ready'
        wait_for:
            host: '{{ instance.ip }}'
            port: '{{ env.JARVIS_SERVICES[app_name].port }}'
            delay: 5
            timeout: 30

      - name: 'BACKREST: Generate Smart Restore Script'
        template:
            src: smart-restore.sh.j2
            dest: /tmp/smart-restore.sh
            mode: '0755'
        delegate_to: localhost
        become: false

      - name: 'BACKREST: Execute Smart Restore'
        script: /tmp/smart-restore.sh
        args:
            executable: /bin/bash
        register: restore_output
        changed_when: "'RESTORE_TRIGGER' in restore_output.stdout"

  rescue:
      - debug:
            msg: '{{ app_name }} failed to deploy'
