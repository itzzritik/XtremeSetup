- block:
      - set_fact:
            app_name: code
            mapped_uid: '{{ instance.subuid | int + 1000 }}'
            path:
                config: '{{ env.JARVIS_CONFIGS_DIR }}/code'
                user_data: '{{ env.JARVIS_CONFIGS_DIR }}/code/data'

      - name: '{{ app_name | upper }}: Configure Directories'
        file:
            path: '{{ item }}'
            state: directory
            mode: '0755'
            owner: '{{ mapped_uid }}'
            group: '{{ mapped_uid }}'
            recurse: true
        loop:
            - '{{ path.config }}'
            - '{{ path.config }}/data'
            - '{{ path.config }}/data/User'

      - name: '{{ app_name | upper }}: Create settings.json'
        copy:
            dest: '{{ path.config }}/data/User/settings.json'
            content: |
                {
                    "workbench.colorTheme": "Material Theme Ocean High Contrast",
                    "workbench.iconTheme": "material-icon-theme"
                }
            owner: '{{ mapped_uid }}'
            group: '{{ mapped_uid }}'
            mode: '0644'

      - name: '{{ app_name | upper }}: Generate Hashed Password'
        shell: pct exec {{ id }} -- docker run --rm alpine sh -c "apk add -q argon2 >/dev/null && echo -n '{{ env.JARVIS_ADMIN_PASSWORD }}' | argon2 \$(head -c 16 /dev/urandom | base64) -e | tail -1"
        register: hashed_password
        changed_when: false

      - name: '{{ app_name | upper }}: Create docker-compose.yml'
        copy:
            dest: '{{ path.config }}/docker-compose.yml'
            content: |
                services:
                  {{ app_name }}:
                    container_name: {{ app_name }}
                    image: linuxserver/code-server:latest
                    restart: unless-stopped
                    environment:
                      - TZ={{ env.JARVIS_TZ }}
                      - PUID=1000
                      - PGID=1000
                      - DEFAULT_WORKSPACE=/AppConfigs
                      - HASHED_PASSWORD={{ hashed_password.stdout | trim | replace('$', '$$') }}
                    ports:
                      - "{{ env.JARVIS_SERVICES[app_name].port }}:8443"
                    volumes:
                      - {{ path.config }}:/config
                      - /:/docker
                      - {{ instance.configs }}:/AppConfigs
            owner: '{{ mapped_uid }}'
            group: '{{ mapped_uid }}'
            mode: '0644'

      - name: '{{ app_name | upper }}: Force Directory Ownership'
        command: chown -R {{ mapped_uid }}:{{ mapped_uid }} {{ path.config }}
        changed_when: false

      - name: '{{ app_name | upper }}: Cleanup Existing Container'
        command: pct exec {{ id }} -- bash -c "docker rm -f {{ app_name }} 2>/dev/null || true"
        changed_when: false

      - name: '{{ app_name | upper }}: Start Docker Compose'
        command: pct exec {{ id }} -- bash -c "cd {{ instance.configs }}/{{ app_name }} && docker compose up -d"
        register: code_compose
        changed_when: "'Created' in code_compose.stderr or 'Recreated' in code_compose.stderr"

      - name: '{{ app_name | upper }}: Wait for Service Ready'
        wait_for:
            host: '{{ instance.ip }}'
            port: '{{ env.JARVIS_SERVICES[app_name].port }}'
            delay: 5
            timeout: 300

      - name: '{{ app_name | upper }}: Install Extensions'
        command: >
            pct exec {{ id }} -- docker exec {{ app_name }} /app/code-server/bin/code-server --install-extension {{ item }} --force
        register: ext_install
        changed_when: "'is already installed' not in ext_install.stdout"
        loop:
            - redhat.vscode-yaml
            - foxundermoon.shell-format
            - vira.vsc-vira-theme
        ignore_errors: true

  rescue:
      - debug:
            msg: '{{ app_name }} failed to deploy'
