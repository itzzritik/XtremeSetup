- block:
      - set_fact:
            app_name: homer
            mapped_uid: '{{ instance.subuid | int + 1000 }}'
            cache_buster: '{{ 999999 | random | to_uuid | hash("md5") | truncate(8, True, "") }}'
            path:
                assets: '{{ env.JARVIS_CONFIGS_DIR }}/homer/assets'

      - name: '{{ app_name | upper }}: Clean assets directory'
        file:
            path: '{{ path.assets }}'
            state: absent

      - name: '{{ app_name | upper }}: Configure Directories'
        file:
            path: '{{ item }}'
            state: directory
            mode: '0755'
            owner: '{{ mapped_uid }}'
            group: '{{ mapped_uid }}'
            recurse: true
        loop:
            - '{{ path.assets }}'
            - '{{ path.assets }}/icons'

      - name: '{{ app_name | upper }}: Generate configuration'
        block:
            - name: '{{ app_name | upper }}: Create config.yml'
              copy:
                  dest: '{{ path.assets }}/config.yml'
                  content: |
                      title: "Jarvis"
                      subtitle: "Home Dashboard"
                      documentTitle: "Jarvis"
                      logo: "assets/icons/logo.svg"
                      header: true
                      footer: false
                      columns: "auto"
                      connectivityCheck: true
                      defaults:
                        layout: list
                        colorTheme: auto
                      stylesheet:
                        - "assets/custom-{{ cache_buster }}.css"
                      colors:
                        light:
                          highlight-primary: "#6366f1"
                          highlight-secondary: "#4f46e5"
                          highlight-hover: "#818cf8"
                          background: "#f8fafc"
                          card-background: "#ffffff"
                          text: "#1e293b"
                          text-header: "#ffffff"
                          text-title: "#0f172a"
                          text-subtitle: "#64748b"
                          card-shadow: rgba(0, 0, 0, 0.08)
                          link: "#6366f1"
                          link-hover: "#4f46e5"
                        dark:
                          highlight-primary: "#6366f1"
                          highlight-secondary: "#4f46e5"
                          highlight-hover: "#818cf8"
                          background: "#0f0f0f"
                          card-background: "#1a1a1a"
                          text: "#e2e8f0"
                          text-header: "#ffffff"
                          text-title: "#f8fafc"
                          text-subtitle: "#94a3b8"
                          card-shadow: rgba(0, 0, 0, 0.4)
                          link: "#818cf8"
                          link-hover: "#a5b4fc"
                      urlSwitcher:
                        homerDomainUrl: "https://{{ env.JARVIS_DOMAIN }}"
                        homerIpUrl: "http://{{ env.JARVIS_NETWORK_PREFIX }}.{{ env.JARVIS_SERVICES.homer.id }}:{{ env.JARVIS_SERVICES.homer.port }}"
                      services:
                        - name: "Services"
                          icon: "fas fa-server"
                          items:
                      {% for k,s in env.JARVIS_SERVICES.items() if k not in ['homer','docker'] %}
                      {% set protocol = 'https' if s.https|default(false) else 'http' %}
                      {% set portSuffix = '' if (s.port==80 and protocol=='http') or (s.port==443 and protocol=='https') else ':'+s.port|string %}
                            - name: "{{ s.name }}"
                              subtitle: "{{ s.subtitle }}"
                              logo: "{{ s.logo }}"
                              url: "https://{% if s.root_domain | default(false) %}{{ env.JARVIS_DOMAIN }}{% else %}{{ s.subdomains[0] | default(k) }}.{{ env.JARVIS_DOMAIN }}{% endif %}{{ s.path | default('') }}"
                              endpoint: "https://{% if s.root_domain | default(false) %}{{ env.JARVIS_DOMAIN }}{% else %}{{ s.subdomains[0] | default(k) }}.{{ env.JARVIS_DOMAIN }}{% endif %}"
                              ip: "{{ protocol }}://{{ env.JARVIS_NETWORK_PREFIX }}.{{ s.id }}{{ portSuffix }}{{ s.path|default('') }}"
                              target: "_blank"
                              tag: "open {{ k }}"
                      {% endfor %}
                  owner: '{{ mapped_uid }}'
                  group: '{{ mapped_uid }}'
                  mode: '0644'

            - name: '{{ app_name | upper }}: Create custom.css'
              copy:
                  src: ../utils/homer/custom.css
                  dest: '{{ path.assets }}/custom-{{ cache_buster }}.css'
                  owner: '{{ mapped_uid }}'
                  group: '{{ mapped_uid }}'
                  mode: '0644'

            - name: '{{ app_name | upper }}: Create assets'
              copy:
                  dest: '{{ path.assets }}/{{ item.file }}'
                  content: '{{ item.content }}'
                  owner: '{{ mapped_uid }}'
                  group: '{{ mapped_uid }}'
                  mode: '0644'
              loop:
                  - file: icons/logo.svg
                    content: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#3498db"/><text x="50" y="62" font-family="Arial" font-size="32" font-weight="bold" fill="white" text-anchor="middle">J</text></svg>'
                  - file: favicon.svg
                    content: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#6366f1"/><text x="50" y="62" font-family="Arial" font-size="32" font-weight="bold" fill="white" text-anchor="middle">J</text></svg>'
                  - file: manifest.json
                    content: |
                        {
                          "name": "Jarvis Dashboard",
                          "short_name": "Jarvis",
                          "description": "Jarvis Home Dashboard",
                          "start_url": "/",
                          "display": "standalone",
                          "background_color": "#131313",
                          "theme_color": "#3498db",
                          "icons": [
                            {
                              "src": "icons/logo.svg",
                              "sizes": "any",
                              "type": "image/svg+xml"
                            }
                          ]
                        }

            - name: '{{ app_name | upper }}: Create URL switcher script'
              copy:
                  src: ../utils/homer/url-switcher.js
                  dest: '{{ path.assets }}/url-switcher-{{ cache_buster }}.js'
                  owner: '{{ mapped_uid }}'
                  group: '{{ mapped_uid }}'
                  mode: '0644'

            - name: '{{ app_name | upper }}: Create custom index.html with script import'
              copy:
                  dest: '{{ path.assets }}/../index.html'
                  content: |
                      <!DOCTYPE html>
                      <html>
                        <head>
                          <meta charset="UTF-8" />
                          <link rel="icon" href="assets/icons/favicon.ico" />
                          <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png" sizes="180x180">
                          <link rel="mask-icon" href="assets/icons/logo.svg">
                          <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
                          <title>Homer</title>
                          <script type="module" crossorigin src="./resources/index-BF4DSS10.js"></script>
                          <link rel="stylesheet" crossorigin href="./resources/index-BUSrgv1m.css">
                          <link rel="manifest" href="./assets/manifest.json" crossorigin="use-credentials">
                          <script id="vite-plugin-pwa:register-sw" src="./registerSW.js"></script>
                        </head>
                        <body>
                          <div id="app-mount"></div>
                          <script src="./assets/url-switcher-{{ cache_buster }}.js"></script>
                        </body>
                      </html>
                  owner: '{{ mapped_uid }}'
                  group: '{{ mapped_uid }}'
                  mode: '0644'

      - name: '{{ app_name | upper }}: Create docker-compose.yml'
        copy:
            dest: '{{ path.assets }}/../docker-compose.yml'
            content: |
                services:
                  {{ app_name }}:
                    container_name: {{ app_name }}
                    image: b4bz/homer
                    restart: unless-stopped
                    ports:
                      - "{{ env.JARVIS_SERVICES[app_name].port }}:8080"
                    volumes:
                      - ./assets:/www/assets
                      - ./index.html:/www/index.html
                    environment:
                      - INIT_ASSETS=0
            owner: '{{ mapped_uid }}'
            group: '{{ mapped_uid }}'
            mode: '0644'

      - name: '{{ app_name | upper }}: Cleanup Existing Container'
        command: pct exec {{ id }} -- bash -c "docker stop {{ app_name }} 2>/dev/null || true; docker rm {{ app_name }} 2>/dev/null || true"
        changed_when: false

      - name: '{{ app_name | upper }}: Start Docker Compose'
        command: pct exec {{ id }} -- bash -c "cd {{ instance.configs }}/{{ app_name }} && docker compose up -d"
        register: homer_compose
        changed_when: "'Created' in homer_compose.stderr or 'Recreated' in homer_compose.stderr"

  rescue:
      - debug:
            msg: '{{ app_name }} failed to deploy'
