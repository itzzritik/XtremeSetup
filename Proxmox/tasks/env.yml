---
- vars:
      project: jarvis
      doppler_required_secrets:
          - JARVIS_ADMIN_EMAIL
          - JARVIS_ADMIN_NAME
          - JARVIS_ADMIN_PASSWORD
          - JARVIS_AUTH_GITHUB_CLIENT_ID
          - JARVIS_AUTH_GITHUB_CLIENT_SECRET
          - JARVIS_AUTH_GOOGLE_APP_PASSWORD
          - JARVIS_AUTH_GOOGLE_CLIENT_ID
          - JARVIS_AUTH_GOOGLE_CLIENT_SECRET
          - JARVIS_AUTH_X_CLIENT_ID
          - JARVIS_AUTH_X_CLIENT_SECRET
          - JARVIS_VOIDAUTH_STORAGE_KEY
          - JARVIS_BOT_EMAIL
          - JARVIS_CF_DNS_API_TOKEN
          - JARVIS_CF_TUNNEL_TOKEN
          - JARVIS_CF_R2_ENDPOINT
          - JARVIS_CF_R2_TOKENS
          - JARVIS_DOMAIN
          - JARVIS_GOOGLE_SERVICE_JSON
          - JARVIS_GITHUB_TOKEN_SSH
          - JARVIS_HA_DECRYPT_KEY
          - JARVIS_POSTGRES_PASSWORD
      local_config:
          JARVIS_BOT_NAME: '{{ project | title }}'
          JARVIS_DIR: '/root/.{{ project }}'
          JARVIS_CONFIGS_DIR: '/root/.{{ project }}/configs'
          JARVIS_ADMIN_USERNAME: 'root'
          JARVIS_NETWORK_PREFIX: '192.168.68'
          JARVIS_GATEWAY: '{{ local_config.JARVIS_NETWORK_PREFIX }}.1'
          JARVIS_DNS_SERVERS: ['8.8.8.8', '8.8.4.4']
          JARVIS_TZ: 'Asia/Kolkata'
          JARVIS_CERT_RESOLVER: 'letsencrypt'
          JARVIS_COMMUNITY_SCRIPTS_URL: 'https://raw.githubusercontent.com/community-scripts/ProxmoxVE/main'
          JARVIS_ICON_CDN: 'https://cdn.jsdelivr.net/gh/selfhst/icons@main/svg/'
          JARVIS_SERVICES:
              docker:
                  id: 253
                  name: Docker
                  subtitle: Container Platform
                  logo: docker.svg
                  port: 2375
                  hidden: true

              voidauth:
                  id: 253
                  name: Auth
                  subtitle: VoidAuth OAuth Provider
                  logo: ceph.svg
                  port: 3000
                  subdomains: [auth]
                  skip_auth: true

              postgres:
                  id: 253
                  name: PostgreSQL
                  subtitle: Database Server
                  logo: databasus.svg
                  port: 5432
                  hidden: true

              homer:
                  id: 253
                  name: Homer
                  subtitle: Dashboard
                  logo: homer.svg
                  port: 8010
                  root_domain: true
                  skip_auth: true
                  hidden: true

              backrest:
                  id: 253
                  name: Backup
                  subtitle: Backrest Backup Manager
                  logo: tpdb.svg
                  port: 9898
                  subdomains: [backup]

              code:
                  id: 253
                  name: Code
                  subtitle: VS Code Server
                  logo: visual-studio-code.svg
                  port: 8888
                  subdomains: [code]

              qbittorrent:
                  id: 253
                  name: Torrent
                  subtitle: qBitTorrent Downloader
                  logo: utorrent.svg
                  port: 8080
                  subdomains: [torrent]

              prowlarr:
                  id: 253
                  name: Prowlarr
                  subtitle: Indexer Manager
                  logo: prowlarr.svg
                  port: 9696
                  subdomains: [prowlarr]

              radarr:
                  id: 253
                  name: Radarr
                  subtitle: Movie Manager
                  logo: radarr.svg
                  port: 7878
                  subdomains: [radarr]

              sonarr:
                  id: 253
                  name: Sonarr
                  subtitle: TV Manager
                  logo: sonarr.svg
                  port: 8989
                  subdomains: [sonarr]

              sonarr-anime:
                  id: 253
                  name: Anime
                  subtitle: Anime Manager
                  logo: anilist.svg
                  port: 8990
                  subdomains: [anime]

              bazarr:
                  id: 253
                  name: Bazarr
                  subtitle: Subtitle Manager
                  logo: bazarr.svg
                  port: 6767
                  subdomains: [bazarr]

              jellyseerr:
                  id: 253
                  name: Jellyseerr
                  subtitle: Request Manager
                  logo: jellyseerr.svg
                  port: 5055
                  subdomains: [request]
                  skip_auth: true

              proxmox:
                  id: 200
                  name: Jarvis Console
                  subtitle: Proxmox Dashboard
                  logo: proxmox.svg
                  port: 8006
                  https: true
                  subdomains: [pm]
                  insecure: true

              traefik:
                  id: 205
                  name: Proxy
                  subtitle: Traefik Reverse Proxy
                  logo: at-t.svg
                  port: 8080
                  subdomains: [proxy]
                  is_internal: true

              files:
                  id: 245
                  name: Files
                  subtitle: NAS & File Manager
                  logo: filebrowser-quantum.svg
                  port: 80
                  subdomains: [files]

              authelia:
                  id: 247
                  name: Authelia
                  subtitle: Authentication Server
                  logo: authelia.svg
                  port: 9091
                  subdomains: [auth]
                  skip_auth: true

              jellyfin:
                  id: 248
                  name: Movies
                  subtitle: Jellyfin Media Server
                  logo: streamyfin.svg
                  port: 8096
                  subdomains: [media, jellyfin]

              home:
                  id: 250
                  name: Smart Home
                  subtitle: Home Assistant Dashboard
                  logo: home-assistant-matter-hub.svg
                  port: 8123
                  subdomains: [home]

              pihole:
                  id: 252
                  name: Pihole
                  subtitle: DNS & Ad Blocker
                  logo: pi-hole.svg
                  port: 80
                  path: /admin
                  subdomains: [dns]
                  middlewares: [pihole-redirect]

  block:
      - name: Ensure Doppler is Installed
        homebrew:
            name: dopplerhq/cli/doppler
            state: present

      - name: Retrieve Doppler Secrets
        block:
            - name: Download Secrets
              command: doppler secrets download --project {{ project }} --config prd --no-file --format json
              register: secrets_output
              changed_when: false
              no_log: true

        rescue:
            - name: Doppler Login Required
              fail:
                  msg: 'FAILED: `doppler login` required for {{ project }}/prd'

      - name: Parse and Verify Secrets
        set_fact:
            doppler_secrets: '{{ secrets_output.stdout | from_json }}'
        no_log: true

      - name: Validate Required Secrets
        assert:
            that: doppler_required_secrets | difference(doppler_secrets.keys()) | length == 0
            fail_msg: 'Missing: {{ doppler_required_secrets | difference(doppler_secrets.keys()) | join(", ") }}'
            success_msg: 'All required secrets are present.'

      - name: Construct Global Environment
        set_fact:
            env: '{{ doppler_secrets | combine(local_config) }}'
        no_log: true

      - name: Success Message
        debug:
            msg: 'Environment configured successfully. {{ env.keys() | length }} variables loaded.'
