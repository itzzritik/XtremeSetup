#!/bin/bash
# Smart Restore Script for Backrest
# This script checks for missing/empty config directories and restores them from R2

# Variables
DOCKER_LXC_ID="{{ env.JARVIS_SERVICES.docker.id }}"
CONFIG_DIR="{{ instance.configs }}"

# R2 Credentials for Restic
export AWS_ACCESS_KEY_ID="{{ env.JARVIS_CF_R2_TOKENS.split(':')[0] }}"
export AWS_SECRET_ACCESS_KEY="{{ env.JARVIS_CF_R2_TOKENS.split(':')[1] }}"
REPO="s3:{{ env.JARVIS_CF_R2_ENDPOINT }}/configs"

{% set docker_apps = ['homer'] %}
{% for svc_key, svc in env.JARVIS_SERVICES.items() %}
{% if svc_key not in ['backrest', 'proxmox', 'home', 'docker'] %}
TARGET="{{ instance.configs }}/{{ svc_key }}"

# Check if directory exists and is strictly empty (no hidden files either)
# Or if it doesn't exist
if [ ! -d "$TARGET" ] || [ -z "$(ls -A "$TARGET")" ]; then
    echo "RESTORE_TRIGGER: {{ svc_key }}"
    
    # Stop Service
    {% if svc_key in docker_apps %}
    echo "Stopping Docker App: {{ svc_key }}"
    pct exec $DOCKER_LXC_ID -- docker stop {{ svc_key }} || true
    {% else %}
    echo "Stopping LXC: {{ svc.id }}"
    pct stop {{ svc.id }} || true
    {% endif %}

    # Perform Restore via Backrest Container
    # We purposefully restore ONLY the specific folder to avoid overwriting others
    echo "Restoring: {{ svc_key }}"
    pct exec $DOCKER_LXC_ID -- docker exec -e AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID" -e AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY" backrest restic -r "$REPO" restore latest --target / --include "/media/configs/{{ svc_key }}" || echo "Restore Failed or No Snapshot"

    # Start Service
    {% if svc_key in docker_apps %}
    echo "Starting Docker App: {{ svc_key }}"
    pct exec $DOCKER_LXC_ID -- docker start {{ svc_key }} || true
    {% else %}
    echo "Starting LXC: {{ svc.id }}"
    pct start {{ svc.id }} || true
    {% endif %}
else
    echo "SKIP: {{ svc_key }} (Content matches)"
    ls -A "$TARGET"
fi
{% endif %}
{% endfor %}
