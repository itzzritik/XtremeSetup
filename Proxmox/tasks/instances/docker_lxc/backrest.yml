- block:
      - set_fact:
            app_name: backrest
            mapped_uid: '{{ instance.subuid | int + 1000 }}'
      - set_fact:
            config:
                root: '{{ env.JARVIS_CONFIGS_DIR }}/{{ app_name }}'
                local: '{{ instance.configs }}/{{ app_name }}'

      - name: '{{ app_name | upper }}: Configure Directories'
        file:
            path: '{{ item }}'
            state: directory
            mode: '0777'
            owner: '{{ mapped_uid }}'
            group: '{{ mapped_uid }}'
            recurse: true
        loop:
            - '{{ config.root }}'
            - '{{ config.root }}/data'

      - name: '{{ app_name | upper }}: Create config.json'
        copy:
            dest: '{{ config.root }}/config.json'
            content: |
                {
                  "version": 6,
                  "instance": "backrest",
                  "auth": {
                    "users": [
                      {
                        "name": "{{ env.JARVIS_ADMIN_USERNAME }}",
                        "passwordBcrypt": "{{ env.JARVIS_ADMIN_PASSWORD_BCRYPT }}"
                      }
                    ]
                  },
                  "repos": [
                    {
                      "id": "r2-backup",
                      "uri": "s3:{{ env.JARVIS_CF_R2_ENDPOINT }}/configs",
                      "password": "{{ env.JARVIS_ADMIN_PASSWORD }}",
                      "env": ["AWS_ACCESS_KEY_ID={{ env.JARVIS_CF_R2_TOKENS.split(':')[0] }}", "AWS_SECRET_ACCESS_KEY={{ env.JARVIS_CF_R2_TOKENS.split(':')[1] }}"],
                      "autoInitialize": true,
                      "prunePolicy": {
                        "maxUnusedPercent": 25
                      },
                      "flags": ["--verbose"]
                    }
                  ],
                  "plans": [
                    {
                      "id": "{{ env.JARVIS_BOT_NAME | lower }}-configs",
                      "repo": "r2-backup",
                      "paths": ["{{ instance.configs }}"],
                      "excludes": ["**/cache/**", "**/.cache/**", "**/logs/**"],
                      "schedule": {
                        "cron": "0 2 */2 * *",
                        "clock": "CLOCK_LOCAL"
                      },
                      "retention": {
                        "policyKeepLastN": 5,
                        "policyKeepDaily": 7,
                        "policyKeepWeekly": 4,
                        "policyKeepMonthly": 6
                      }
                    }
                  ]
                }
            owner: '{{ mapped_uid }}'
            group: '{{ mapped_uid }}'
            mode: '0666'

      - name: '{{ app_name | upper }}: Create docker-compose.yml'
        copy:
            dest: '{{ config.root }}/docker-compose.yml'
            content: |
                services:
                  {{ app_name }}:
                    container_name: {{ app_name }}
                    image: garethgeorge/backrest
                    restart: unless-stopped
                    ports:
                      - "{{ env.JARVIS_SERVICES[app_name].port }}:9898"
                    volumes:
                      - {{ config.local}}/data:/data
                      - {{ config.local}}:/config
                      - {{ instance.configs }}:{{ instance.configs }}:ro
                      - /media/ssd:/media/ssd
                      - /media/wdhdd:/media/wdhdd
                    environment:
                      - BACKREST_DATA=/data
                      - BACKREST_CONFIG=/config/config.json
                      - XDG_CACHE_HOME=/cache
                      - TZ={{ env.JARVIS_TZ }}
            owner: '{{ mapped_uid }}'
            group: '{{ mapped_uid }}'
            mode: '0666'

      - name: '{{ app_name | upper }}: Cleanup Existing Container'
        command: pct exec {{ id }} -- bash -c "docker stop {{ app_name }} 2>/dev/null || true; docker rm {{ app_name }} 2>/dev/null || true"
        changed_when: false

      - name: '{{ app_name | upper }}: Start Docker Compose'
        command: pct exec {{ id }} -- bash -c "cd {{ config.local }} && docker compose up -d"
        register: backrest_compose
        changed_when: "'Created' in backrest_compose.stderr or 'Recreated' in backrest_compose.stderr"

      - name: '{{ app_name | upper }}: Wait for Service Ready'
        wait_for:
            host: '{{ instance.ip }}'
            port: '{{ env.JARVIS_SERVICES[app_name].port }}'
            delay: 5
            timeout: 30

      - name: '{{ app_name | upper }}: Generate Smart Restore Script'
        template:
            src: smart-restore.sh.j2
            dest: /tmp/smart-restore.sh
            mode: '0777'
        delegate_to: localhost
        become: false

      # - name: '{{ app_name | upper }}: Execute Smart Restore'
      #   script: /tmp/smart-restore.sh
      #   args:
      #       executable: /bin/bash
      #   register: restore_output
      #   changed_when: "'RESTORE_TRIGGER' in restore_output.stdout"

  rescue:
      - debug:
            msg: '{{ app_name }} failed to deploy'
