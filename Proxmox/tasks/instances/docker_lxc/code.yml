- block:
      - set_fact:
            app_name: code
            mapped_uid: '{{ instance.subuid | int + 1000 }}'
      - set_fact:
            config:
                root: '{{ env.JARVIS_CONFIGS_DIR }}/{{ app_name }}'
                local: '{{ instance.configs }}/{{ app_name }}'

      - name: '{{ app_name | upper }}: Configure Directories'
        file:
            path: '{{ item }}'
            state: directory
            mode: '0755'
            owner: '{{ mapped_uid }}'
            group: '{{ mapped_uid }}'
            recurse: true
        loop:
            - '{{ config.root }}'
            - '{{ config.root }}/data'
            - '{{ config.root }}/data/User'

      - name: '{{ app_name | upper }}: Create settings.json'
        copy:
            dest: '{{ config.root }}/data/User/settings.json'
            content: |
                {
                    "workbench.colorTheme": "Material Theme Ocean High Contrast",
                    "workbench.iconTheme": "material-icon-theme"
                }
            owner: '{{ mapped_uid }}'
            group: '{{ mapped_uid }}'
            mode: '0644'

      - name: '{{ app_name | upper }}: Create docker-compose.yml'
        copy:
            dest: '{{ config.root }}/docker-compose.yml'
            content: |
                services:
                  {{ app_name }}:
                    container_name: {{ app_name }}
                    image: linuxserver/code-server:latest
                    restart: unless-stopped
                    environment:
                      - TZ={{ env.JARVIS_TZ }}
                      - PUID=1000
                      - PGID=1000
                      - PWA_APPNAME={{ env.JARVIS_BOT_NAME }} Code
                      - DEFAULT_WORKSPACE=/AppConfigs
                    ports:
                      - "{{ env.JARVIS_SERVICES[app_name].port }}:8443"
                    volumes:
                      - {{ config.local }}/data:/config
                      - /:/docker
                      - {{ instance.configs }}:/AppConfigs
            owner: '{{ mapped_uid }}'
            group: '{{ mapped_uid }}'
            mode: '0644'

      - name: '{{ app_name | upper }}: Force Directory Ownership'
        command: chown -R {{ mapped_uid }}:{{ mapped_uid }} {{ config.root }}
        changed_when: false

      - name: '{{ app_name | upper }}: Cleanup Existing Container'
        command: pct exec {{ id }} -- bash -c "docker rm -f {{ app_name }} 2>/dev/null || true"
        changed_when: false

      - name: '{{ app_name | upper }}: Start Docker Compose'
        command: pct exec {{ id }} -- bash -c "cd {{ config.local }} && docker compose up -d"
        register: code_compose
        changed_when: "'Created' in code_compose.stderr or 'Recreated' in code_compose.stderr"

      - name: '{{ app_name | upper }}: Wait for Service Ready'
        wait_for:
            host: '{{ instance.ip }}'
            port: '{{ env.JARVIS_SERVICES[app_name].port }}'
            delay: 5
            timeout: 300

      - name: '{{ app_name | upper }}: Install Extensions'
        command: pct exec {{ id }} -- docker exec {{ app_name }} /app/code-server/bin/code-server --extensions-dir /config/extensions --user-data-dir /config/data {{ extensions | map('regex_replace', '^', '--install-extension ') | join(' ') }} --force
        vars:
            extensions:
                - redhat.vscode-yaml
                - foxundermoon.shell-format
                - vira.vsc-vira-theme
        ignore_errors: true

      - name: '{{ app_name | upper }}: Restart Container'
        command: pct exec {{ id }} -- docker restart {{ app_name }}
        changed_when: false

  rescue:
      - debug:
            msg: '{{ app_name }} failed to deploy'
