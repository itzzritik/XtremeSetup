- set_fact:
      app_name: qbittorrent

- name: '{{ app_name | upper }}: Check Existing Configuration'
  stat:
      path: '{{ config.root }}/{{ app_name }}/qBittorrent.conf'
  register: qbit_config_exists

- name: '{{ app_name | upper }}: Generate Password Hash'
  shell: |
      python3 -c 'import base64, hashlib, os; password = os.environ.get("QB_PASSWORD", "").encode(); salt = os.urandom(16); key = hashlib.pbkdf2_hmac("sha512", password, salt, 100000); print("@ByteArray({}:{})".format(base64.b64encode(salt).decode(), base64.b64encode(key).decode()), end="")'
  environment:
      QB_PASSWORD: '{{ env.JARVIS_ADMIN_PASSWORD }}'
  register: qbit_password_hash
  changed_when: false

- name: '{{ app_name | upper }}: Stop Container for Configuration'
  command: pct exec {{ id }} -- docker stop {{ app_name }}
  ignore_errors: true
  changed_when: false
  retries: 5
  delay: 5
  until: result.rc == 0 or result.rc == -11
  register: result

- name: '{{ app_name | upper }}: Configure Settings'
  copy:
      dest: '{{ config.root }}/{{ app_name }}/qBittorrent.conf'
      content: |
          [Preferences]
          WebUI\HostHeaderValidation=false
          WebUI\AlternativeUIEnabled=true
          WebUI\RootFolder=/vuetorrent
          Downloads\SavePath=/downloads
          Downloads\TempPath=/downloads/incomplete
          Downloads\TempPathEnabled=true
          WebUI\AuthSubnetWhitelistEnabled=true
          WebUI\AuthSubnetWhitelist=127.0.0.1/32,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
          WebUI\Username={{ env.JARVIS_ADMIN_USERNAME }}
          WebUI\Password_PBKDF2={{ qbit_password_hash.stdout | trim }}
          BitTorrent\Session\DefaultSavePath=/downloads
          BitTorrent\Session\TempPath=/downloads/incomplete
          BitTorrent\Session\TempPathEnabled=true
          BitTorrent\Session\Port=6881
          Connection\PortRangeMin=6881
          Connection\UPnP=false
          Preferences\WebUI\CSRFProtection=false
          Preferences\Connection\ResolvePeerCountries=true
      owner: '{{ mapped_uid }}'
      group: '{{ mapped_uid }}'
      mode: '0666'

- name: '{{ app_name | upper }}: Configure Download Categories'
  community.general.ini_file:
      path: '{{ config.root }}/{{ app_name }}/qBittorrent.conf'
      section: 'Preferences'
      option: '{{ qbit_item.key }}'
      value: '{{ qbit_item.value }}'
      owner: '{{ mapped_uid }}'
      group: '{{ mapped_uid }}'
      mode: '0666'
  loop:
      - { key: 'Downloads\\SavePathHistory', value: '/downloads, /downloads/movies, /downloads/tv, /downloads/anime' }
  loop_control:
      loop_var: qbit_item

- name: '{{ app_name | upper }}: Create Categories Config'
  copy:
      dest: '{{ config.root }}/{{ app_name }}/categories.json'
      content: |
          {
              "movies": {
                  "save_path": "/downloads/movies"
              },
              "tv": {
                  "save_path": "/downloads/tv"
              },
              "anime": {
                  "save_path": "/downloads/anime"
              }
          }
      owner: '{{ mapped_uid }}'
      group: '{{ mapped_uid }}'
      mode: '0666'

- name: '{{ app_name | upper }}: Start Container'
  command: pct exec {{ id }} -- docker start {{ app_name }}
  changed_when: false
  retries: 5
  delay: 5
  register: start_result
  until: start_result.rc == 0

- name: '{{ app_name | upper }}: Install VueTorrent'
  shell: |
      pct exec {{ id }} -- docker exec -u 0 {{ app_name }} sh -c "
      apk add --no-cache unzip curl &&
      curl -L https://github.com/VueTorrent/VueTorrent/releases/latest/download/vuetorrent.zip -o /tmp/vuetorrent.zip &&
      unzip -o /tmp/vuetorrent.zip -d / &&
      chmod -R 755 /vuetorrent &&
      rm /tmp/vuetorrent.zip"
  changed_when: true

- name: '{{ app_name | upper }}: Wait for Service Ready'
  wait_for:
      host: '{{ instance.ip }}'
      port: '{{ env.JARVIS_SERVICES[app_name].port }}'
      delay: 3
      timeout: 60
